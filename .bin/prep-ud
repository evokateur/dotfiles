#!/bin/bash

wait_for() {
    func="$1"
    timeout_seconds=10
    elapsed_seconds=0
    while [ $elapsed_seconds -lt "$timeout_seconds" ]; do
        if "$func"; then
            return 0
        fi
        sleep 1
        elapsed_seconds=$((elapsed_seconds + 1))
    done
    return 1
}

vpn_is_connected() {
    mullvad status | grep "Connected" >/dev/null
}

tell() {
    local some_app="$1"
    local what="$2"

    case "$what" in
    quit)
        pgrep -x "$some_app" >/dev/null || return 1
        ;;
    activate)
        ! pgrep -x "$some_app" >/dev/null || return 1
        ;;
    esac

    echo "telling $some_app to $what.."
    osascript -e "tell application \"$some_app\" to $what" || return 1
}

tell "Dropbox" "activate"

echo "starting full charge cycle.."
bclm-cc || exit 1

tell "Docker Desktop" "quit"
tell "Dropbox" "quit"

if ! vpn_is_connected; then
    # tell_app "Mullvad VPN" "activate"
    echo "telling mullvad to connect.."
    mullvad connect || exit 1
fi

if wait_for "vpn_is_connected"; then
    echo "vpn connected; undock!, undock!"
else
    echo "vpn failed to connect" >&2
    exit 1
fi
